-- Dashboard Metrics for ops.tattty.com
-- This file contains SQL queries for monitoring AI request performance

-- 1. OVERALL PERFORMANCE DASHBOARD
SELECT 
    action_type,
    COUNT(*) as total_requests,
    AVG(response_time_ms) as avg_response_time_ms,
    AVG(input_char_count) as avg_input_length,
    AVG(output_char_count) as avg_output_length,
    SUM(CASE WHEN was_successful THEN 1 ELSE 0 END) as successful_requests,
    SUM(CASE WHEN NOT was_successful THEN 1 ELSE 0 END) as failed_requests,
    COUNT(DISTINCT session_id) as unique_sessions
FROM ask_tattty_requests 
WHERE created_at >= NOW() - INTERVAL '24 HOURS'
GROUP BY action_type
ORDER BY total_requests DESC;

-- 2. HOURLY REQUEST VOLUME
SELECT 
    DATE_TRUNC('hour', created_at) as hour_bucket,
    action_type,
    COUNT(*) as requests_per_hour,
    AVG(response_time_ms) as avg_response_time
FROM ask_tattty_requests 
WHERE created_at >= NOW() - INTERVAL '24 HOURS'
GROUP BY hour_bucket, action_type
ORDER BY hour_bucket DESC, requests_per_hour DESC;

-- 3. ERROR ANALYSIS
SELECT 
    action_type,
    error_message,
    COUNT(*) as error_count,
    AVG(response_time_ms) as avg_time_before_error
FROM ask_tattty_requests 
WHERE NOT was_successful 
    AND created_at >= NOW() - INTERVAL '24 HOURS'
    AND error_message IS NOT NULL
GROUP BY action_type, error_message
ORDER BY error_count DESC
LIMIT 20;

-- 4. PERFORMANCE TRENDS (LAST 7 DAYS)
SELECT 
    DATE(created_at) as request_date,
    action_type,
    COUNT(*) as daily_requests,
    AVG(response_time_ms) as avg_daily_response_time,
    SUM(CASE WHEN was_successful THEN 1 ELSE 0 END) / COUNT(*)::float as success_rate
FROM ask_tattty_requests 
WHERE created_at >= NOW() - INTERVAL '7 DAYS'
GROUP BY request_date, action_type
ORDER BY request_date DESC, daily_requests DESC;

-- 5. KEYHOLDER ENGAGEMENT METRICS
SELECT 
    session_id,
    COUNT(*) as total_requests,
    COUNT(DISTINCT action_type) as different_actions_used,
    MIN(created_at) as first_request,
    MAX(created_at) as last_request,
    AVG(response_time_ms) as avg_session_response_time
FROM ask_tattty_requests 
WHERE created_at >= NOW() - INTERVAL '7 DAYS'
GROUP BY session_id
HAVING COUNT(*) >= 2
ORDER BY total_requests DESC
LIMIT 50;